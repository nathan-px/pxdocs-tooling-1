{{ define "main" -}}
  {{- partial "contentheader.html" . -}}

  <!-- take input from the shortcode as a string -->
  {{- $source := .Page.Params.datasource -}}
  <!-- set the path to the `automateTable` location -->
  {{- $pathTo := .Site.Data -}}
  <!-- Use the index function to fetch the location object using the source string. Without this, Hugo doesn't understand what the `source` string means -->
  {{- $pathToSource := index $pathTo $source -}}
  {{ $countvar := 0 }}

  
  {{ partial "recursive.html" (dict "context" . "pathToSource" $pathToSource "countvar" $countvar) }}
  
{{/* end main */}}
{{ end }}

{{ define "partials/recursive.html" }}
  {{- $pathToSource := .pathToSource }}
  {{- $fullcommand := .fullcommand }}
  {{- $countvar := .countvar }}

  {{ range .pathToSource }}

    <h2>{{ .name }}</h2>

    {{/* {{ if not findRE "(pxctl)(.*)" $fullcommand }}  */}}
    {{ if eq $countvar 0 }}
      {{ $fullcommand = printf "pxctl %s" .name }}
    {{ else }}
      {{ $fullcommand = printf "%s %s" $fullcommand .name }}
    {{ end }}

    <h4>{{ $fullcommand }}</h4>

    {{- printf "```text\n%s\n```" .name | markdownify -}}

    {{- if or .long .short -}}
      <h3> Description </h3>
      {{- if .long -}}
        {{- .long -}}
      {{- else -}}
        {{- .short -}}
      {{- end -}}
    {{- end -}}

    {{- if .example -}}
      <h3> Example </h3>
      {{- printf "```text\n%s\n```" .example | markdownify -}}
    {{- end -}}

    {{- if .flags -}}
      <h3> Flags </h3>
      
      <table class="cli-reference-table">
        <th>Flag</th>
        <th>Description</th>
        {{- range .flags -}}
        <tr>
          <td>
            <p>
            {{- $.Scratch.Add "shorthand" "" -}}
            {{- $.Scratch.Add "type" "" -}}
            {{- if .singleLetterShorthand -}}
              {{- $.Scratch.Add "shorthand" (printf ", `%s`" .singleLetterShorthand) -}}
            {{- end -}}
            {{- if .type -}}
              {{- $.Scratch.Add "type" (printf " (`%s`)" .type) -}}
            {{- end -}}
            {{- printf "`%s`%s%s" .name ($.Scratch.Get "shorthand")  ($.Scratch.Get "type") | markdownify -}}
            {{- $.Scratch.Delete "shorthand" -}}
            {{- $.Scratch.Delete "type" -}}
          </p>
          </td>
          <td>
            <p>
            {{- .use -}}
            </p>
          
          {{- if .default -}}
            <p>
              {{- printf "_Default value:_ %v" .default | markdownify -}}
            </p>
            {{- end -}}
          {{- if .required -}}
            <p>
              {{- printf "_Required:_ %t" .required | markdownify -}}
            </p>
          {{- end -}}
          {{- if .validValues -}}
            <i>Valid values:</i>
            <ul>
              {{- with .validValues -}}
                {{- range . -}}
                  <li>
                    {{- printf " %v" . -}}
                  </li>
                {{- end -}}
              {{- end -}}
            </ul>
          {{- end -}}
          {{- if .validRange -}}
            <p>
              {{- printf "_Valid range:_ %s" .validRange | markdownify -}}
            </p>
          {{- end -}}
          </td>
        </tr>
      
        {{- end -}}
      </table>
      
    {{- end -}}

    {{- if .subcmd -}}
      {{ $countvar = 1}}
      {{ partial "recursive.html" (dict "context" . "pathToSource" .subcmd "fullcommand" $fullcommand "countvar" $countvar) }}
    {{- end -}}

    {{ $countvar = 0 }}

  {{/* end range pathToSource */}}  
  {{- end -}}
{{/* end recursive */}}  
{{- end -}}
